#!/bin/bash
# Install script for dotfiles dependencies
# Supports: Debian/Ubuntu (apt), Arch (pacman), Fedora (dnf)

set -e

echo "==> Detecting package manager..."

# Core packages
CORE="i3 i3blocks zsh rofi kitty tmux neovim fzf ripgrep curl git"

# i3 ecosystem (from i3 config)
I3_DEPS="dex xss-lock i3lock brightnessctl flameshot dunst clipmenu xdotool"

# Audio/system
AUDIO="wireplumber playerctl network-manager-gnome"

# i3blocks script dependencies  
SCRIPT_DEPS="perl python3 lm-sensors"

if command -v apt &>/dev/null; then
    PM="apt"
    INSTALL="sudo apt update && sudo apt install -y"
    # Adjust package names for Debian/Ubuntu
    PACKAGES="$CORE $I3_DEPS $AUDIO $SCRIPT_DEPS"
    PACKAGES="${PACKAGES//i3 /i3 }"
    PACKAGES="${PACKAGES//network-manager-gnome/network-manager-gnome}"
elif command -v pacman &>/dev/null; then
    PM="pacman"
    INSTALL="sudo pacman -Syu --noconfirm"
    # Adjust package names for Arch
    PACKAGES="$CORE $I3_DEPS $AUDIO $SCRIPT_DEPS"
    PACKAGES="${PACKAGES//i3 /i3-wm }"
    PACKAGES="${PACKAGES//network-manager-gnome/nm-connection-editor}"
    PACKAGES="${PACKAGES//lm-sensors/lm_sensors}"
elif command -v dnf &>/dev/null; then
    PM="dnf"
    INSTALL="sudo dnf install -y"
    PACKAGES="$CORE $I3_DEPS $AUDIO $SCRIPT_DEPS"
    PACKAGES="${PACKAGES//network-manager-gnome/NetworkManager-applet}"
else
    echo "Error: No supported package manager found (apt, pacman, dnf)"
    exit 1
fi

echo "==> Using $PM"
echo "==> Installing packages:"
echo "    $PACKAGES"
echo ""

eval "$INSTALL $PACKAGES"

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "==> Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Set zsh as default shell
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "==> Setting zsh as default shell..."
    chsh -s "$(which zsh)"
    echo "    You'll need to log out and back in for this to take effect."
fi

# Add ~/.config/scripts to PATH in .zshrc if not present
SCRIPT_PATH_LINE='export PATH="$HOME/.config/scripts:$PATH"'
if ! grep -qF '.config/scripts' "$HOME/.zshrc" 2>/dev/null; then
    echo "==> Adding ~/.config/scripts to PATH in .zshrc..."
    echo "" >> "$HOME/.zshrc"
    echo "# Custom scripts" >> "$HOME/.zshrc"
    echo "$SCRIPT_PATH_LINE" >> "$HOME/.zshrc"
fi

# Also add to .bashrc for bash users
if ! grep -qF '.config/scripts' "$HOME/.bashrc" 2>/dev/null; then
    echo "==> Adding ~/.config/scripts to PATH in .bashrc..."
    echo "" >> "$HOME/.bashrc"
    echo "# Custom scripts" >> "$HOME/.bashrc"
    echo "$SCRIPT_PATH_LINE" >> "$HOME/.bashrc"
fi

# Copy dotfiles to system
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

echo "==> Installing dotfiles from $DOTFILES_DIR..."
"$SCRIPT_DIR/dotfiles" pull

echo ""
echo "==> Installation complete!"
echo ""
echo "Installed:"
echo "  - Window manager: i3, i3blocks, rofi, dunst"
echo "  - Terminal: kitty, tmux, zsh (with Oh My Zsh)"
echo "  - Editor: neovim"
echo "  - Utils: fzf, ripgrep, flameshot, brightnessctl, clipmenu"
echo ""
echo "Next steps:"
echo "  1. Log out and back in (for zsh to take effect)"
echo "  2. Reload i3 with mod+Shift+r"
echo "  3. Run 'dotfiles status' to check your dotfiles"
