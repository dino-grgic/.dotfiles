#!/bin/bash
# Install script for dotfiles dependencies
# Supports: Debian/Ubuntu (apt), Arch (pacman), Fedora (dnf)

echo "==> Detecting package manager..."

# Function to install packages, skipping ones that fail
install_packages() {
    local pm="$1"
    shift
    local packages=("$@")
    local failed=()
    
    for pkg in "${packages[@]}"; do
        echo "  Installing $pkg..."
        case "$pm" in
            apt)
                if ! sudo apt install -y "$pkg" 2>/dev/null; then
                    failed+=("$pkg")
                fi
                ;;
            pacman)
                if ! sudo pacman -S --noconfirm "$pkg" 2>/dev/null; then
                    failed+=("$pkg")
                fi
                ;;
            dnf)
                if ! sudo dnf install -y "$pkg" 2>/dev/null; then
                    failed+=("$pkg")
                fi
                ;;
        esac
    done
    
    if [ ${#failed[@]} -gt 0 ]; then
        echo ""
        echo "  Warning: Failed to install: ${failed[*]}"
        echo ""
    fi
}

# Detect package manager and set package names
if command -v apt &>/dev/null; then
    PM="apt"
    sudo apt update
    
    PACKAGES=(
        # Window manager & bar
        i3 i3blocks i3lock rofi dunst
        
        # Terminal & shell
        kitty tmux zsh
        
        # Editor
        neovim
        
        # CLI tools
        fzf ripgrep curl git xdotool
        
        # i3 ecosystem
        dex xss-lock brightnessctl flameshot
        
        # Audio & bluetooth
        wireplumber playerctl blueman pasystray pavucontrol
        
        # Tray applets
        network-manager-gnome
        
        # i3blocks dependencies
        perl python3 lm-sensors
        
        # Clipboard
        xclip
        
        # X utilities
        xrandr arandr
    )
    
elif command -v pacman &>/dev/null; then
    PM="pacman"
    sudo pacman -Syu
    
    PACKAGES=(
        # Window manager & bar
        i3-wm i3blocks i3lock rofi dunst
        
        # Terminal & shell
        kitty tmux zsh
        
        # Editor
        neovim
        
        # CLI tools
        fzf ripgrep curl git xdotool
        
        # i3 ecosystem
        dex xss-lock brightnessctl flameshot
        
        # Audio & bluetooth
        wireplumber playerctl blueman pasystray pavucontrol
        
        # Tray applets
        nm-connection-editor network-manager-applet
        
        # i3blocks dependencies
        perl python lm_sensors
        
        # Clipboard
        xclip
        
        # X utilities
        xorg-xrandr arandr
    )
    
elif command -v dnf &>/dev/null; then
    PM="dnf"
    
    PACKAGES=(
        # Window manager & bar
        i3 i3blocks i3lock rofi dunst
        
        # Terminal & shell
        kitty tmux zsh
        
        # Editor
        neovim
        
        # CLI tools
        fzf ripgrep curl git xdotool
        
        # i3 ecosystem
        dex xss-lock brightnessctl flameshot
        
        # Audio & bluetooth
        wireplumber playerctl blueman pasystray pavucontrol
        
        # Tray applets
        NetworkManager-applet
        
        # i3blocks dependencies
        perl python3 lm_sensors
        
        # Clipboard
        xclip
        
        # X utilities
        xrandr arandr
    )
else
    echo "Error: No supported package manager found (apt, pacman, dnf)"
    exit 1
fi

echo "==> Using $PM"
echo "==> Installing ${#PACKAGES[@]} packages..."
echo ""

install_packages "$PM" "${PACKAGES[@]}"

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "==> Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Set zsh as default shell
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "==> Setting zsh as default shell..."
    chsh -s "$(which zsh)"
    echo "    You'll need to log out and back in for this to take effect."
fi

# Add ~/.config/scripts to PATH in .zshrc if not present
SCRIPT_PATH_LINE='export PATH="$HOME/.config/scripts:$PATH"'
if ! grep -qF '.config/scripts' "$HOME/.zshrc" 2>/dev/null; then
    echo "==> Adding ~/.config/scripts to PATH in .zshrc..."
    echo "" >> "$HOME/.zshrc"
    echo "# Custom scripts" >> "$HOME/.zshrc"
    echo "$SCRIPT_PATH_LINE" >> "$HOME/.zshrc"
fi

# Also add to .bashrc for bash users
if ! grep -qF '.config/scripts' "$HOME/.bashrc" 2>/dev/null; then
    echo "==> Adding ~/.config/scripts to PATH in .bashrc..."
    echo "" >> "$HOME/.bashrc"
    echo "# Custom scripts" >> "$HOME/.bashrc"
    echo "$SCRIPT_PATH_LINE" >> "$HOME/.bashrc"
fi

# Setup WORK_MODE environment variable
echo "==> Setting up WORK_MODE environment variable..."

BASHRC_FILE="$HOME/.bashrc"
ZSHRC_FILE="$HOME/.zshrc"
PROFILE_FILE="$HOME/.profile"

# Check which shell config file to use
if [ -f "$ZSHRC_FILE" ]; then
    SHELL_CONFIG="$ZSHRC_FILE"
    echo "    Detected zsh, using $ZSHRC_FILE"
elif [ -f "$BASHRC_FILE" ]; then
    SHELL_CONFIG="$BASHRC_FILE"
    echo "    Detected bash, using $BASHRC_FILE"
else
    echo "    Warning: No shell config file found, creating ~/.bashrc"
    touch "$BASHRC_FILE"
    SHELL_CONFIG="$BASHRC_FILE"
fi

# Check if WORK_MODE is already defined
if grep -q "export WORK_MODE" "$SHELL_CONFIG"; then
    echo "    WORK_MODE already defined in $SHELL_CONFIG"
else
    echo "" >> "$SHELL_CONFIG"
    echo "# i3blocks work mode toggle (0=personal, 1=work)" >> "$SHELL_CONFIG"
    echo "export WORK_MODE=0" >> "$SHELL_CONFIG"
    echo "    Added WORK_MODE=0 to $SHELL_CONFIG"
fi

# Add to .profile if it exists (for display managers)
if [ -f "$PROFILE_FILE" ]; then
    if grep -q "export WORK_MODE" "$PROFILE_FILE"; then
        echo "    WORK_MODE already defined in $PROFILE_FILE"
    else
        echo "" >> "$PROFILE_FILE"
        echo "# i3blocks work mode toggle (0=personal, 1=work)" >> "$PROFILE_FILE"
        echo "export WORK_MODE=0" >> "$PROFILE_FILE"
        echo "    Added WORK_MODE=0 to $PROFILE_FILE"
    fi
fi

# Create convenience aliases
echo "==> Adding work mode toggle aliases..."

ALIAS_BLOCK="
# i3blocks work mode toggle aliases
alias work-mode='export WORK_MODE=1 && i3-msg restart'
alias personal-mode='export WORK_MODE=0 && i3-msg restart'
alias check-mode='[ \"\$WORK_MODE\" = \"1\" ] && echo \"Work mode\" || echo \"Personal mode\"'
"

if ! grep -q "alias work-mode" "$SHELL_CONFIG"; then
    echo "$ALIAS_BLOCK" >> "$SHELL_CONFIG"
    echo "    Added mode toggle aliases to $SHELL_CONFIG"
else
    echo "    Aliases already exist in $SHELL_CONFIG"
fi

# Copy dotfiles to system
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

echo "==> Installing dotfiles from $DOTFILES_DIR..."
"$SCRIPT_DIR/dotfiles" pull

echo ""
echo "==> Installation complete!"
echo ""
echo "Installed:"
echo "  - Window manager: i3, i3blocks, i3lock, rofi, dunst"
echo "  - Terminal: kitty, tmux, zsh (with Oh My Zsh)"
echo "  - Editor: neovim"
echo "  - CLI tools: fzf, ripgrep, xdotool"
echo "  - Tray: nm-applet, blueman, pasystray"
echo "  - Utils: flameshot, brightnessctl, xclip, arandr"
echo "  - Work mode: WORK_MODE=0 (personal mode by default)"
echo ""
echo "Work mode commands:"
echo "  work-mode       - Switch to work mode (hides music player)"
echo "  personal-mode   - Switch to personal mode (shows music player)"
echo "  check-mode      - Check current mode"
echo ""
echo "Next steps:"
echo "  1. Log out and back in (for zsh to take effect)"
echo "  2. Start i3 from your display manager"
echo "  3. Run 'dotfiles status' to check your dotfiles"
