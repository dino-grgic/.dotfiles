#!/usr/bin/env bash
set -e

DOTFILES="$HOME/.dotfiles"
STOW_FOLDERS="nvim,i3,i3blocks,kitty,dunst,rofi,tmux,zsh,bin,screenlayout"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}==>${NC} $1"; }
warn() { echo -e "${YELLOW}==>${NC} $1"; }
error() { echo -e "${RED}==>${NC} $1"; }

usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -a, --all        Install packages and stow dotfiles"
    echo "  -p, --packages   Install packages only"
    echo "  -s, --stow       Stow dotfiles only (default)"
    echo "  -l, --list       List packages that would be installed"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0              # Stow dotfiles only"
    echo "  $0 --all        # Full install (packages + stow)"
    echo "  $0 --packages   # Install packages only"
}

# Detect package manager
detect_pkg_manager() {
    if command -v apt &>/dev/null; then
        echo "apt"
    elif command -v pacman &>/dev/null; then
        echo "pacman"
    elif command -v dnf &>/dev/null; then
        echo "dnf"
    elif command -v brew &>/dev/null; then
        echo "brew"
    else
        echo "unknown"
    fi
}

# Read packages from file, filtering comments and empty lines
get_packages() {
    local pkg_file="$DOTFILES/packages.txt"
    if [ -f "$pkg_file" ]; then
        grep -v '^#' "$pkg_file" | grep -v '^$' | tr '\n' ' '
    else
        error "packages.txt not found"
        exit 1
    fi
}

install_nerd_font() {
    local font_dir="$HOME/.local/share/fonts"
    local font_name="JetBrainsMono"
    
    if fc-list | grep -qi "JetBrainsMono Nerd Font"; then
        info "JetBrains Mono Nerd Font already installed"
        return 0
    fi
    
    info "Installing JetBrains Mono Nerd Font..."
    mkdir -p "$font_dir"
    cd "$font_dir"
    
    wget -q --show-progress "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/${font_name}.zip" -O "${font_name}.zip"
    unzip -o "${font_name}.zip" -d "$font_name"
    rm "${font_name}.zip"
    
    fc-cache -fv
    info "JetBrains Mono Nerd Font installed!"
}

install_packages() {
    local pkg_manager=$(detect_pkg_manager)
    local packages=$(get_packages)
    
    info "Detected package manager: $pkg_manager"
    info "Installing packages..."
    
    case $pkg_manager in
        apt)
            sudo apt update
            sudo apt install -y $packages
            ;;
        pacman)
            # Try yay first for AUR support, fall back to pacman
            if command -v yay &>/dev/null; then
                yay -S --needed --noconfirm $packages
            else
                sudo pacman -S --needed --noconfirm $packages
            fi
            ;;
        dnf)
            sudo dnf install -y $packages
            ;;
        brew)
            brew install $packages
            ;;
        *)
            error "Unknown package manager. Install packages manually:"
            echo "$packages"
            exit 1
            ;;
    esac
    
    # Install Nerd Font (not in standard repos)
    install_nerd_font
    
    info "Packages installed!"
}

stow_dotfiles() {
    info "Stowing dotfiles..."
    
    pushd "$DOTFILES" > /dev/null
    
    for folder in $(echo "$STOW_FOLDERS" | sed "s/,/ /g"); do
        if [ -d "$folder" ]; then
            echo "  Stowing $folder..."
            stow -D "$folder" 2>/dev/null || true
            stow "$folder"
        else
            warn "  Skipping $folder (not found)"
        fi
    done
    
    popd > /dev/null
    
    info "Making scripts executable..."
    [ -d "$HOME/.local/scripts" ] && chmod +x "$HOME/.local/scripts/"* 2>/dev/null || true
    [ -d "$HOME/.config/i3blocks/scripts" ] && chmod +x "$HOME/.config/i3blocks/scripts/"* 2>/dev/null || true
    [ -d "$HOME/.screenlayout" ] && chmod +x "$HOME/.screenlayout/"*.sh 2>/dev/null || true
    
    info "Dotfiles stowed!"
}

post_install() {
    echo ""
    info "Post-install steps:"
    echo "  - Change shell to zsh: chsh -s \$(which zsh)"
    echo "  - Reload i3: mod+Shift+r"
    echo "  - Restart your shell: exec zsh"
    echo "  - Font used: JetBrains Mono Nerd Font (includes icons)"
}

# Default action
ACTION="stow"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--all)
            ACTION="all"
            shift
            ;;
        -p|--packages)
            ACTION="packages"
            shift
            ;;
        -s|--stow)
            ACTION="stow"
            shift
            ;;
        -l|--list)
            ACTION="list"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Execute
case $ACTION in
    all)
        install_packages
        echo ""
        stow_dotfiles
        post_install
        ;;
    packages)
        install_packages
        ;;
    stow)
        stow_dotfiles
        post_install
        ;;
    list)
        info "Packages to install:"
        get_packages | tr ' ' '\n' | grep -v '^$'
        ;;
esac

echo ""
info "Done!"
